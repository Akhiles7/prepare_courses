---
- name: Add key
  apt_key:
    keyserver: "{{ key_server }}"
    id: "{{ repo_key  }}"

- name: Add Docker repository
  apt_repository:
    repo: "{{ repo_server }}"
    state: present

- name: Install Docker Engine
  apt:
    name: docker-engine
    state: latest
    update_cache: yes

- name: Enable Docker service
  service:
    name: docker
    enabled: yes

- shell: docker -v
  register: dout

- fail: msg="Docker is not v17.0+. Wrong version!"
  when: "not '17.0' in dout.stdout"

- name: Install Docker python modules
  shell: "pip install {{ item }}"
  with_items:
    - docker==2.0.1
    - docker-compose

- name: Create course path
  file:
    path: "{{ course_path }}"
    state: directory
    mode: 0755
    owner: "{{ course_user }}"
    group: "{{ course_user }}"
  tags: dirs

- name: Remove old Docker compose file
  file:
    state: absent
    path: "{{ old_course_path }}/docker-compose.yml"
  tags: docker-compose

- name: Move Docker compose file
  template:
    src: docker-compose.j2
    dest: "{{ course_path }}/docker-compose.yml"
    owner: "{{ course_user }}"
    group: "{{ course_user }}"
  tags: docker-compose

- name: Remove old directories
  file:
    path: "{{ item }}"
    state: absent 
  with_items:
    - "{{ old_course_path }}/bitbucket/"
    - "{{ old_course_path }}/jenkins-backup/"
    - "{{ old_course_path }}/jenkins-workspace/"
    - "{{ old_course_path }}/jenkins-workspce/"
    - "{{ old_course_path }}/artifactory/"
    - "{{ old_course_path }}/nexus-data/"
    - "{{ old_course_path }}/nginx/"
    - "{{ old_course_path }}/sonarqube/"
    - "{{ old_course_path }}/juseppe/"
    - "{{ old_course_path }}/.juseppe/"
    - "{{ old_course_path }}/jenkins0"
    - "{{ old_course_path }}/.jenkins/"
    - "{{ old_course_path }}/jenkins-pipeline-workshop/"
    - "{{ old_course_path }}/workspace/"
    - "{{ old_course_path }}/Downloads/slave.jar"
  tags: dirs

- name: Prepare directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ course_user }}"
    group: "{{ course_user }}"
    mode: 0777 #For training course only!
  with_items:
    - "{{ course_path }}/bitbucket"
    - "{{ course_path }}/jenkins-backup"
    - "{{ course_path }}/jenkins-workspace/.jenkins"
    - "{{ course_path }}/artifactory"
    - "{{ course_path }}/nexus-data"
    - "{{ course_path }}/nginx"
    - "{{ course_path }}/sonarqube"
    - "{{ course_path }}/sonarqube/conf"
    - "{{ course_path }}/sonarqube/data"
    - "{{ course_path }}/sonarqube/extensions"
    - "{{ course_path }}/sonarqube/plugins"
    - "{{ course_path }}/juseppe"
  tags: dirs

- name: Cloning jenkins-pipeline-workshop repo
  git:
    repo: "https://github.com/gavriluk/jenkins-pipeline-workshop"
    dest: "{{ course_path }}/jenkins-pipeline-workshop"
    force: yes
  tags: repo

- name: Prepare .jenkins-workspace
  file:
    path: "{{ course_path }}/jenkins-pipeline-workshop/.jenkins-workspace"
    state: directory
    owner: 10000
    group: 10000
    mode: 0755

- name: Create symlink for jenkins0
  file:
    src: "{{ course_path }}/jenkins-pipeline-workshop/.jenkins0"
    dest: "{{ course_path }}/jenkins0"
    owner: "{{ course_user }}"
    group: "{{ course_user }}"
    state: link
    force: yes

- name: Fix .jenkins0 chmod
  file:
    path: "{{ course_path }}/jenkins-pipeline-workshop"
    owner: "{{ course_user }}"
    group: "{{ course_user }}"
    recurse: yes
- name: Fix nexus chmod
  file:
    path: "{{ course_path }}/nexus-data"
    owner: 200
    group: 200
    recurse: yes

- name: Adding user {{ course_user }} into docker group
  user: 
    name: "{{ course_user }}"
    groups: docker
    append: yes

- name: Pull Slave image #Need to move this to docker-compose!
  ignore_errors: True
  docker_image:
    name: "{{ image.slave }}" 
    pull: yes 
  tags: pull-slave-image

- name: Pull Docker images
  ignore_errors: True
  docker_service:
    project_src: "{{ course_path }}"
    pull: yes
